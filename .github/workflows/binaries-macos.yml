name: MacOS-11

on:
  workflow_dispatch:
    branches: [ master ]

permissions:
  contents: read

jobs:
  build:
    runs-on: macos-11
    steps:
      - uses: actions/checkout@v3
      - name: Install dependencies on MacOS and compile and produce mecw, mec and standalone ME application 
        if: runner.os == 'macOS'
        run: |
           echo `uname -a`
           ls
           brew install xquartz
           brew install gcc
           brew install make
           cd microemacs/3rdparty/zlib && /usr/local/opt/make/libexec/gnubin/make -f macos64cc.mak CC=gcc-10
           cd ../tfs && /usr/local/opt/make/libexec/gnubin/make -f macos64cc.mak CC=gcc-10
           cd ../../src 
           /usr/local/opt/make/libexec/gnubin/make -f macos64cc.mak  CC=gcc-10
           /usr/local/opt/make/libexec/gnubin/make -f macos64cc.mak  CC=gcc-10 BTYP=c
           ls -la
           cd ../..
           mkdir binaries-MacOS-11
           cp microemacs/src/.macos64cc-release-mecw/mecw binaries-MacOS-11/
           cp microemacs/src/.macos64cc-release-mec/mec binaries-MacOS-11/
           cp microemacs/3rdparty/tfs/.macos64cc-release/tfs binaries-MacOS-11/
           
           cd microemacs 
           tar cfvz macros.tar.gz macros/*
           cp macros.tar.gz ../binaries-MacOS-11/
           cd ..
           echo '-1 ml-write &cat "Platform   :" $platform' >  platform.emf
           echo '-1 ml-write &cat "Platformc  :" %platform' >> platform.emf
           echo "exit-emacs" >> platform.emf
           MEPATH=`pwd`/microemacs/macros TERM=xterm-256color ./microemacs/src/.macos64cc-release-mec/mec @platform.emf
           cd ../
      - name: Make tfs executable
        run: |
           cd microemacs/mesingle
           export PATH=`pwd`/../src/.macos64cc-release-mec/:$PATH
           export PATH=`pwd`/../3rdparty/tfs/.macos64cc-release/:$PATH
           bash mesgen.sh -d -p ../src/.macos64cc-release-mecw/mecw   -o ../../binaries-MacOS-11/mecw-macos64cc-11.bin
           bash mesgen.sh -d -p ../src/.macos64cc-release-mec/mec -o  ../../binaries-MacOS-11/mec-macos64cc-11.bin
           cd ../../
           TERM=xterm-256color ./binaries-MacOS-11/mec-macos64cc-11.bin @platform.emf
      - name: Upload Artifact GitHub Action MacOS executables
        uses: actions/upload-artifact@v3
        with: 
           name: binaries-MacOS-11
           path: binaries-MacOS-11
           
