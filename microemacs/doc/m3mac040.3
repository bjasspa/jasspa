.\" -*- nroff -*-
.\" Copyright (C) 1998-2009 JASSPA (www.jasspa.com)
.\"
.\" This is part of JASSPA's MicroEmacs, see the LICENSE file for licensing and
.\" copying information.
.\"
.Id $Id: m3mac040.3,v 2.6 2026/01/30 17:52:57 jon Exp $
.Im MicroEmacs command|file
.so me.tni
.TH find-zfile 3
.XI find-zfile - "Compressed file support"
.XI zfile-setup - "Compressed file support setup"
.XI zfile-reset - "Compressed file support reset"
.SH NAME
.Me "|find-zfile"
find-zfile \- Compressed file support
.br
.Me "|zfile-setup"
zfile-setup \- Compressed file support setup
.br
.Me "|zfile-reset"
zfile-reset \- Compressed file support reset
.Me $a
.SH SYNOPSIS
.\"TODO document single-file xpipe form
.na
\fBfind-zfile\fR "\fIfile-name\fR"
.br
\fBzfile-setup\fR "\fIzfile-id\fR" "\fIextension-regex\fR" "\fIlist-command\fR"
.br
.RS
"\fItop-cut-to-regex\fR" "\fIbottom-cut-to-regex\fR"
.br
[ "\fIbody-search-regex1\fR" "\fIbody-replace-regex1\fR" "\fIbody-search-regex2\fR" "\fIbody-replace-regex2\fR" ... ]
.br
"\fIchange-slashes\fR" "\fIbottom-summary-search-regex\fR" "\fIbottom-summary-replace-regex\fR"
.br
"\fIlist-header\fR" "\fIextract-command\fR"
.RE
\fBzfile-setup\fR "\fIzfile-id\fR" "\fIextension-regex\fR" "" "\fIpiped-extract-command\fR"
.br
\fBzfile-reset\fR
.ad
.SH DESCRIPTION
\fBfind-zfile\fR provides generic support for listing and extracting the contents of compressed files,
\fBfind-zfile\fR also supports the extraction and loading of the internal files into a buffer.
.PP
\fBfind-zfile\fR must be configured for each compression utility using \fBzfile-setup\fR. It relies on command-line
programs to generate content lists which are used to generate the main file listing, and subsequently, the ability to
extract individual files for file extraction support.
.PP
For basic content listing support the first 3 arguments must be given to zfile-setup. The first argument is a tool ID, 
if an existing tool's ID is entered \fBzfile-setup\fR will reconfigure the tool, otherwise a new tool will be created. 
The second argument, "\fIextension-regex\fR" is used to match a file to this utility, the file's full name is compared 
with ".*\\.<\fIextension-regex>\fR" and if matched the tool will be used. Comparisons are always case insensitive for 
improved cross-platform behaviour.
.PP
The compressed file contents list is generated from executing the user supplied "\fIlist-command\fR" and dumping the
output into the list buffer. The command is run from the directory containing the compressed file and the following
special tags may be used within the "\fIlist-command\fR" which get substituted as follows:-
.IP \fB%%\fR
The token is replaced with a single '\fC%\fR'.
.IP \fB%"\fR\fC<str>\fR\fB%"\fR
The \fB%"\fR tokens are replaced with '\fC"\fR's if \fC<str>\fR contains a space, if it doesn't they are simply 
removed.
.IP \fB%zb\fR
The token is replaced with the compressed file's base name, i.e. the file name without the path or the extension.
.IP \fB%ze\fR
The token is replaced with the compressed file's extension, i.e. the string matched by the \fIextension-regex\fR, note 
this can be multiple extensions if, for example, \fIextension-regex\fR match '\fCtar.gz\fR'.
.IP \fB%zf\fR
The token is replaced with the compressed file's file name, i.e. the file name without the path but with the 
extension.
.IP \fB%zp\fR
The token is replaced with the compressed file's absolute path, including a trailing '\fC/\fR'. All directories will 
be separated by a '\fC/\fR' character.
extension.
.IP \fB%zP\fR
The token is replaced with the compressed file's absolute path, including a trailing '\fC/\fR'. However, unlike 
\fB%zp\fR the character used to separate directories will be the OS preferred character, see index 0 of
.Ht %os-chars 5 . 
.PP
The head of the list output is often unwanted verbose printout, this can be automatically be removed by the use of the
"\fItop-cut-to-regex\fR" argument. The argument, if supplied (not an empty string), must be a
.Hl "regex" RegularExpressions 2
search string matching the end of the text to be removed. If found, all text from the end of the match and before is removed.
.PP
To improve usability, the list typically needs reformatting so that items can be selected (first column must be a 
space) and the list can be sorted on the main column headings. This is achieved by supplying \fIbody\fR regex-based 
search and replace strings, as many can be supplied as required. Note that the result should ensure the information 
given for each item aligns with the column heading otherwise the sort features are unlike to work. Of particular 
important is the item name, if this is miss-aligned the item extraction is unlikely to work.
.PP
The bottom of the output often has summary information, such as the total number of files a size etc. \*(mS puts the 
summary information for directory listing on the second line, and for consistency zfile does too. This can be best 
achieved by supplying the \fIbottom-summary\fR regex-based search & replace strings, if the search matched the replace 
string is inserted into the second line of the buffer. If no summary search is supplied zfile creates a basic file 
and directory count summary.
.PP
For extraction to work, the given \fIlist-header\fR line must include the string '\fBName\fR' and this sting must 
be aligned to the start of each item's file or directory name. For copying, viewing or editing files, the same key 
bindings used in directory listing are also supported by zfile.
.PP
The selected files are then extracted by executing the supplied "\fIextract-command\fR" to the selected destination,
if copying, or to a temporary directory which is automatically removed later. As with the \fIlist-command\fR, the
extract command is run from the directory containing the compressed file and the same \fB%z?\fR tokens can be used.
The command line must contain a \fC%p\fR or \fC%P\fR token to specify the output location, it can also use the %% & %"
tokens, %f for the item name and \fB%*[\fR\fC...\fR\fB]\fR for multiple file support, see help on
.Ht file-tool-setup 3
for more information on this last token.
.PP
When first used, if there are currently no compression utilities configured \*(mS will test for the availability of
.Hr 7zip 1 ,
.Hr tar 1
and
.Hr gunzip 1 ,
and automatically configure the tool appropriately. If these tools, particularly \fB7zip\fR are available then use of 
\fBzfile-setup\fR may not be necessary. However, the system setup or the default configuration of \*(mS may change, in 
which case \fBzfile-reset\fR should be run, this will remove any existing zfile configuration for the current 
platform, including any manual configuration, and regenerate the bast default setup available. 
.SH EXAMPLE
For zip file support the freely available
.Hr unzip 1
command can be used, running "\fCunzip -l /tmp/Jasspa_MicroEmacs_macros.zip\fR" produces an output like the following:
.CS
Archive:  Jasspa_MicroEmacs_macros.zip
  Length     Date   Time    Name
 --------    ----   ----    ----
        0  18-09-24 01:18   macros/
     3552  18-09-24 01:18   macros/dmf.emf
     1413  18-09-24 01:18   macros/langutl.emf
    22193  18-09-24 01:18   macros/hkcpp.emf
        \&\.
        \&\.
        \&\.
     2314  18-09-24 01:18   macros/hkrd.emf
    18910  18-09-24 01:18   COPYING.txt
     4759  18-09-24 01:18   readme.txt
 --------                   -------
  3461536                   364 files
.CE
The following configuration can be used:
.CS
zfile-id=zip
extension-regex=\\(zip\\|epub\\|apk\\)
list-command=unzip -l %zf
top-cut-to-regex=---\\n
bottom-cut-to-regex=^ ---
body-search-regex1=        0  \\([-\\d: ]\\{14\\}\\)   \\(.*/\\)$
body-replace-regex1= d...          0  \\1 \\2
body-search-regex2=^\\([ \\d]\\{9\\}\\)  \\([-\\d: ]\\{14\\}\\)   \\(.*\\)$
body-replace-regex2= ....  \\1  \\2 \\3
change-slashes=0
bottom-summary-search-regex=^ *\\(\\d+\\) +\\(\\d+ files\\)
bottom-summary-replace-regex=    \\1 used in \\2
list-header= Attr     Length        Modified Name
extract-command=unzip -o %zf %*[ %"%f%"] -d %"%p%"
.CE
With this setup, running find-zfile on this zip file will produce the following listing:
.CS
ZFile-zip: /tmp/Jasspa_MicroEmacs_macros.zip
    3461536 used in 364 files

 Attr     Length        Modified Name
 d...          0  18-09-24 01:18 macros/
 ....       3552  18-09-24 01:18 macros/dmf.emf
 ....       1413  18-09-24 01:18 macros/langutl.emf
 ....      22193  18-09-24 01:18 macros/hkcpp.emf
    \&\.
    \&\.
    \&\.
 ....       2314  18-09-24 01:18 macros/hkrd.emf
 ....      18910  18-09-24 01:18 COPYING.txt
 ....       4759  18-09-24 01:18 readme.txt
.CE
The top 3 lines are removed as they are not required due to the reformatting requiring a new header line. Each 
directory line is reformatted first and flags with a '\fCd\fR' Attribute, the remaining file lines are then 
reformatted. The bottom summary information is matched with the search regex so the useful information it contains can 
be pulled out and inserted onto the second line.
.PP
As the names of all items now align with the '\fCName\fR' string in the new header, the extraction process will get 
the correct names. Note that files search as \fCdmf.emf\fR will be extracted into a \fCmacros\fR sub-directory.
.SH NOTES
\fBfind-zfile\fR, \fBzfile-setup\fR, and \fBzfile-reset\fR are macros defined in \fCzfile.emf\fR.
.PP
The order in which the tools are defined can be important and priority is given to the last tool defined. So if the
tool currently being used to support a compressed file type could be improved, another tool can be added for that
extension and will be used in preference.
.SH "SEE ALSO"
.na
.Ht find-file 2 ,
.Ht find-hfile 3 .
.ad
.FH
