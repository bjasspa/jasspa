.\" -*- nroff -*-
.\" Copyright (C) 1988-2009 JASSPA (www.jasspa.com)
.\"
.\" This is part of JASSPA's MicroEmacs, see the LICENSE file for licensing and
.\" copying information.
.\"
.Id $Id: m2cmd003.2,v 2.7 2026/01/29 23:56:32 jon Exp $
.Im MicroEmacs command|macrodevelop
.so me.tni
.TH major-mode 2
.XI major-mode - "Declare or set a buffer major mode"
.XI add-file-hook - "Depreciated"
.SH NAME
.br
.Me "|major-mode"
major-mode \- Declare or set a buffer major mode
.br
.Me "|add-file-hook"
add-file-hook \- Depreciated, update to major-mode
.Me $a
.SH SYNOPSIS
.na
\fBmajor-mode\fR \fIid\fR
.br
\fI0\fR \fBmajor-mode\fR \fIid\fR
.br
\fIn\fR \fBmajor-mode\fR \fIid\fR
["\fIcid-label\fR"]
["\fIextension-list\fR"]
["\fIfull-name\fR"]
[\fIcid-line-count\fR "\fIcid-regex\fR"]
["\fImacro1-name\fR" "\fImacro2-name\fR" ...]
.br
\fI16\fR \fBmajor-mode\fR \fIid\fR [\fIcid-line-count\fR "\fIcid-regex\fR"]
.ad
.\" TODO SSP need to finish
.SH DESCRIPTION
The
.B major-mode 
command is used to define new major modes, the main 'type' of a buffer or file, such as \fCC\fR or \fCHTML\fR etc. The
command can be used to configure or reconfigure the base properties of a major-mode, such as its supported extension
list, and it can be used to change the major-mode of the current buffer.
.PP
When the major-mode of a buffer is assigned, the buffer's
.Ht $buffer-major-mode 5
and
.Ht $buffer-fhook 5
variables are assigned and the macro pointed to by the \fB$buffer-fhook\fR variable is executed, this macro, and the 
hook file it is defined in, are responsible for setting up features such as hilighting and indentation rules for the 
major-mode and ultimately for the buffer.
.PP
When no argument \fIn\fR is given to the command, \fBmajor-mode\fR prompts the user for the current buffer's new mode.
If a new mode \fIid\fR is entered, the major-mode is immediately applied, if the buffer's current major-mode ID is given
the command prints the full name of the current major-mode, its content label (if enabled) and the name of the hook
file.
.PP
If a positive numeric argument \fIn\fR is given to the command the major-mode \fIid\fR must be given and the effect of
the bits of the numeric argument are defined as follows:
.IP \fB0x01\fR
When set the major-mode will be created if it does not already; an error is returned if the bit is clear and the 
given major-mode \fIid\fR does not exist.
.IP \fB0x02\fR
When set the content-ID label of the major-mode is assigned the value of \fIcid-label\fR, if the value is an empty 
string (i.e. "") the feature is disabled. See the notes section below for more information on the use of the 
content-ID label. When this bit is clear the value remains unchanged unless this call is also creating the major-mode, 
in which case the cid-label is set to the same value as the \fIid\fR.
.IP \fB0x04\fR
When set the file extensions associated with the major-mode is set to \fIextension-list\fR. The argument is a space
separated list of \fIfile endings\fR (as opposed to true extensions) and is usually specified with the extension
separator. For example, the extension list "\fC.c .h\fR" maybe used for C major-mode to associate files ending in
\fC.c\fR or \fC.h\fR. A '\fC/\fR' character at the start of an extension can be used to force the match of the whole
file name, for example the Unix info system often have directories with a '\fCdir\fR' file, an extension-list value of
"\fC.info /dir\fR" will match any file ending in \fC.info\fR and a file with the name \fCdir\fR. Similarly, if the
extension starts with a '\fC^\fR' character the start of the file name is matched instead, the difference to '\fC/\fR'
is that the file name only has to start with the extension. If \fIextension-list\fR is an empty string the feature is
disable. If bit \fB0x04\fR is clear the value remains unchanged unless this is the initial creation call, in which case the
value is set to ".\fIid\fR". Extension-list values are not concatenation when the \fIextension-list\fR is redefined,
the full list of extensions must be give. Note also that the comparison is always case insensitive to ensure 
consistent behaviour across all platforms.
.IP \fB0x08\fR
When set the full name of the major-mode is set to \fIfull-name\fR. When this bit is clear the value remains unchanged
unless this call is also creating the major-mode, in which case the name is set to the capitalised value of
\fBcid-label\fR or \fBid\fR if not set. The name is uppercased if the value does not contain a vowel, e.g. \fCHTML\fR.
.IP \fB0x10\fR
When set the \fIcid-line-count\fR and \fIcid-regex\fR parameters are used to define a content based identifier, to be
identified a file must have content within the first \fIcid-line-count\fR non-blank lines which matches the given
\fIcid-regex\fR. If the given line count is positive the id regex search will be case sensitive, if negative the
search is case insensitive and the count is negated. When bit \fB0x10\fR is used on its own, a special 'regex replace'
form of the \fIid\fR can be used, see the Notes section below for more information.
.PP
Optionally, when bit \fB0x01\fR is set a list of macro definitions ("\fImacro1-name\fR" "\fImacro2-name\fR" ...) can 
also be given, see Notes section below.
.PP
The order in which the major-modes are defined can be important when there is a conflict in assignment, for example, both C 
nd C++ can use the \fB.h\fR extension. Priority is given to the last defined major-mode, i.e. the first defined has 
the lowest priority, to ensure that any user created major-modes will have the highest priority. However, this order 
can be manipulated by simply redefining the major-mode if an argument of 1, i.e. adding the following line to the end 
of your user macro file would make the shell script major-mode the highest priority:
.Me $emf-scheme
.CS
   1 major-mode "sh"
.CE
.Me $ehf-scheme
.\" TODO: doc ftest-<id> function 
If a numerical argument of 0 is given to \fBmajor-mode\fR the command uses the variable
.Ht $result 5
to return information about the given \fIid\fR major-mode in the following \*(mS
.Hl list &lget 4
format:
.CS
   \\b<id>\\b<flags>\\b<cid-label>\\b<extension-list>\\b<full-name>\\b
.CE
Where '\fC\\b\fR' is the list value separator character. The \fI<flags>\fR member is a bit based integer with the 
following flags:
.IP \fB0x01\fR
If set, the initialisation of the major-mode has been attempted, if bit \fB0x02\fR is also set then the attempt was 
successful and the major-mode would have been applied to a buffer, if bit \fB0x02\fR is clear then \*(mS failed to 
locate the major-mode's \fCfhook-\fR\fI<id>\fR macro and aborted.
.IP \fB0x02\fR
If set the major-mode has been successfully initialised and the \fCfhook-\fR\fI<id>\fR macro located.
.IP \fB0x04\fR
If set the major-mode has an \fCftest-\fR\fI<id>\fR macro, this macro will be called to help resolve major-mode 
assignment conflicts based solely on the file name's extension. This bit will always be clear until the hook is 
successfully initialised.
.IP \fB0x08\fR
If set the major-mode has a \fCbhook-\fR\fI<id>\fR macro, see
.Ht $buffer-bhook 5 .
This bit will always be clear until the hook is successfully initialised.
.IP \fB0x10\fR
If set the major-mode has an \fCehook-\fR\fI<id>\fR macro, see
.Ht $buffer-ehook 5 .
This bit will always be clear until the hook is successfully initialised.
.IP \fB0x20\fR
If set the major-mode has a \fCdhook-\fR\fI<id>\fR macro, see
.Ht $buffer-dhook 5 .
This bit will always be clear until the hook is successfully initialised.
.SS "Order of Events"
The major-modes must be defined first, this typically happens in the main \fBme.emf\fR macro file, user and company 
created major-modes are typically defined in the user and company macro file. The definition at this stage is minimal 
to enable \*(mS to start-up as quickly as possible, a single call to \fBmajor-mode\fR will usually suffice.
.PP
When the user loads a file \*(mS loops through all major-modes, in order, checking every defined 
content-id from the start of the first non-blank line. If a match is in the buffer the major-mode is initialised if 
not already (see below) and assigned to the buffer.
.PP
If no content-id based match was found, \*(mS loops through all major-modes, in order, checking every defined
extension list. If a match is found the major-mode is initialised, if required, and checked for the existence of a
\fCftest-\fR\fI<id>\fR macro. If the macro does exists it is executed and the return assessed, if it does not exist
the buffer is simply assumed to be of that type. If the buffer is found to be definitely of that type the major-mode
is immediately assigned and the search halted, otherwise the probability of the buffer being of that type is stored
and the search is continued. If, by the end, no definite match has been found, the most likely major-mode is assigned,
or the \fCdefault\fR major-mode if no possible match was found.
.PP
If a major-mode has been assigned, the major-modes 
.Ht $buffer-fhook 5
function (anemd \fCfhook-\fR\fI<id>\fR) will be executed with the buffer current so that the hook macro can configure 
settings such as the hilighting & indentation schemes, buffer based binding and modes etc.
.SH NOTES
A major-mode is deemed initialised if the main \fCfhook-\fR\fI<id>\fR macro is defined. If it is not, \*(mS attempts
to locate and execute the associated hook file, \fChk\fR\fI<id>\fR\fC.emf\fR. If the file is not found or, having
executed the file, the main \fCfhook-\fR\fI<id>\fR macro is still not defined the initialisation is considered failed
and the major-mode becomes unusable.
.PP
When \fBmajor-mode\fR is called with a numeric argument of 16, a special 'regex replace' style of \fIid\fR can be 
used, for example:
.Me $emf-scheme
.CS
16 major-mode "\\\\1" -2 "-[*!]- *\\\\(\\\\m+\\\\).*?-[*!]-"
.CE
.Me $ehf-scheme
In this form the \fIid\fR string must be a '\\' character followed by a digit between \fC0\fR and \fC7\fR which must
refer to a group within the \fIcid-regex\fR. When a match is found the value of the group is compared with all
major-mode content-id labels (\fIcid-label\fR) and if a match is found that mode is applied. This has the major
advantage of being able to support all major-modes in a single regex search, greatly reducing the performance impact
of content based identification.
.PP
Optionally \fBmajor-mode\fP can be given a list of macros, "\fImacro1-name\fR" etc., when bit \fB0x01\fR is set. These
macros must be defined within the hook file \fBhk\fR\fI<id>\fR\fB.emf\fR, the command will define the macros in the
same way as command
.Ht define-macro-file 2 .
Only macros useful before a file of the given type is created or loaded should be defined as loading the hook will 
define all macros within it.
.PP
The numeric argument given when the \fB$buffer-fhook\fR macro is executed is a bit based flag where the bits have the 
following meaning:
.IP \fB0x01\fR
When this bit is set the buffer is for a file that already exists, when clear the buffer is for a new file so the 
\fBfhook\fR should handle the insertion of any required file templates etc.
.IP \fB0x02\fR
If this bit is set a file content hook was used to identify the file type and registry variable
.Hl #l9 Variables 4
will be set to the matched magic string. This can be useful as the magic string often contains configuration values such as 
the tab and indent width.
.SS "Extending a standard hook definition"
The standard file hook files \fBhk\fR\fIXXX\fR\fB.emf\fR should not be modified. The standard file hooks may be
extended with local definitions by defining a file \fBmy\fR\fIXXX\fR\fB.emf\fR, which is an extension to the hook file
\fBhk\fR\fIXXX\fR\fB.emf\fR. This is automatically executed after \fBhk\fR\fIXXX\fR\fB.emf\fR. Refer to sections
.Hl "Language Templates" languageTemplates 2 
and
.Hl "File Hooks" fileHooks 2 
for details.
.SS "File Extensions"
The file extensions are specified as a space separated list of file name endings. Back-up file endings such as tilde
(\fC~\fR) are not classed as correct file endings and are skipped by the file hook search, hence a file ending
"\fC.c~\fR" invokes the same hook function as a "\fC.c\fR" file. It is therefore not necessary to add the backup and
auto-save endings to the major mode definition.
.PP 
The extension separator, usually dot (\fC.\fR), is typically added to the \fIextensions\fR list, they may be omitted
with effect where a file always ends in the same set of characters. A notable example is "\fCmakefile\fR" which
includes no extension, as such, \*(mS applies the same hook function to a file called \fCImakefile\fR as the endings
are the same. This can be avoided by defining the extension as "\fC/makefile\fR" which only matches files whose whole 
name is "makefile".
.SS "Binary Files"
It is sometimes useful to associate file types as binary files, so that they are immediately loaded in binary. In this
case, both file extension and content recognition methods (i.e. of a magic string) are applicable. In both cases the
file is bound to the well known hook \fCfhook-binary\fR which automatically loads the file in a binary mode. 
.PP
Note, that for binary major-mode recognition, via extension or content-ID, the file must be loaded twice, initially in 
the default text mode, then it must be reloaded in binary mode once identified. For this reason it is better to load 
the file directly into binary mode using
.Ht find-bfile 3
or
.Ht find-hfile 3 .
.SH MIGRATION
In January 2026 the existing command \fBadd-file-hook\fR was replaced with \fBmajor-mode\fR with the aim to consolidating the 
major-mode concept and improving compatibility with Emacs. As a result, all existing calls to \fBadd-file-hook\fR need to be 
migrated to \fBmajor-mode\fR.
.PP
Calls to \fBadd-file-hook\fR took one of two different forms:
.IP "File Extension Recognition"
Calls without a numeric argument were used to bind a list of extensions to a file-hook macro. If migrating such a 
call, first determine if the hook is a standard system hook by locating the \fChk\fR\fI<id>\fR\fC.emf\fR and if so whether the extensions are now supported by 
checking the relevant call to \fBmajor-mode\fR in the current \fCme.emf\fR. If the hook is a system one and all extensions 
are listed then the call to add-file-hook can be removed. If the hook is a system one but not all extensions are listed, replace the 
add-file-hook line with one like the following:
.RS
.Me $emf-scheme
.CS
   4 major-mode "<id>" "<combined-full-extension-list>"
.CE
.Me $ehf-scheme
Where <id> is taken from the hook macro name which should have the form \fCfhook-\fR\fI<id>\fR. If it is not a system
hook, replace the line with one like the following:
.Me $emf-scheme
.CS
   5 major-mode "<id>" "<extension-list>"
.CE
.Me $ehf-scheme
If the hook file contains a user friendly name for the hook, e.g. contains a line like the following:
.Me $emf-scheme
.CS
   set-variable .fhook-<id>.name "<File-type-name>"
.CE
.Me $ehf-scheme
Then remove this line from the hook file and change the call to major-mode to:
.Me $emf-scheme
.CS
   13 major-mode "<id>" "<extension-list>" "<File-type-name>"
.CE 0
.Me $ehf-scheme
.RE
.IP "File Content Recognition"
Calls giving a numeric argument to add-file-hook were used to define a content based identifier, given in the form of a regex 
search pattern. Many of these content-IDs take the form of "\fC-*- <id> -*-\fR"
or "\fC-!- <id> -!-\fR", these are generally no longer required as the new major-mode \fIcid-label\fR feature automatically
performs the same function. If the label used in the content-ID is something other than \fI<id>\fR then the call to 
add-file-line can usually be replaced with:
.RS
.Me $emf-scheme
.CS
   3 major-mode "<id>" "<cid-label>"
.CE
.Me $ehf-scheme
If this is not a system hook then this can be combined with an extension-based major-mode definition, i.e. a single 
call to major-mode like one of the following:
.Me $emf-scheme
.CS
   7 major-mode "<id>" "<cid-label>" "<extension-list>"
   15 major-mode "<id>" "<cid-label>" "<extension-list>" "<File-type-name>"
.CE
.Me $ehf-scheme
However, if there is more than one label or the content-ID does not take this form then replace the call to 
add-file-hook with a line of the following form:
.Me $emf-scheme
.CS
   17 major-mode "<id>" n "<regex>"
.CE
.Me $ehf-scheme
Where <id> is taken from the hook macro name which should have the form \fCfhook-\fR\fI<id>\fR, \fIn\fR is the 
numeric argument given and  \fI<regex>\fR is the first argument given. Again, if this is not a system hook this line 
can be combined with the major-mode definition call unless there are more than one.
.RE
.SH "SEE ALSO"
.na
.Hl "File Hooks" fileHooks 2 ,
.Hl "Language Templates" languageTemplates 2 ,
.Ht $buffer-major-mode 5 ,
.Ht $buffer-fhook 5 ,
.Ht find-bfile 3 ,
.Ht find-hfile 3 ,
.Ht define-macro-file 2 .
.ad
.FH
